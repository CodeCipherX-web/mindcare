<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MindCare â€” My Journal Folder</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" 
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2300b4d8'/%3E%3Cpath d='M20 36c0-5 4-9 9-9s9 4 9 9v10c0 3 2 5 5 5s5-2 5-5V36' stroke='white' stroke-width='4' fill='none' stroke-linecap='round'/%3E%3Cpath d='M32 22a6 6 0 0 1 6 6' stroke='white' stroke-width='4' fill='none' stroke-linecap='round'/%3E%3C/svg%3E">

  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- Header -->
  <header>
    <h1>MindCare</h1>
    <nav>
      <a href="/">Home</a>
      <a href="/resources">Resources</a>
      <a href="/chatbot">Chatbot</a>
      <a href="/mood-tracker">Mood Tracker</a>
      <a href="/contact">Contact</a>
      <a href="/journal">Journal</a>
      <a href="/journal-folder">My Journal Folder</a>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <h2>My Journal Folder</h2>
    <p>Review all your saved journal entries below.</p>
  </section>

  <!-- Journal Entries List -->
  <section class="journal-container" id="journalList">
    <!-- Dynamically loaded entries -->
  </section>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <p>&copy; 2025 MindCare. All rights reserved.</p>
    </div>
  </footer>

  <script src="/js/main.js"></script>
  <script>
    // Utility function to prevent XSS
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    const journalList = document.getElementById('journalList');

    async function loadJournal() {
      if (!journalList) return;
      
      try {
        const res = await fetch('/api/journal');
        if (!res.ok) throw new Error('Failed to fetch journal entries');
        
        const response = await res.json();
        const entries = (response.success && Array.isArray(response.data)) ? response.data : [];
        journalList.innerHTML = '';

        if (entries.length === 0) {
          journalList.innerHTML = '<p class="no-data">No journal entries yet. Start writing!</p>';
          return;
        }

        entries.forEach(entry => {
          const div = document.createElement('div');
          div.classList.add('journal-card');
          div.innerHTML = `
            <h4>${escapeHtml(entry.title || 'Untitled')}</h4>
            <p>${escapeHtml(entry.content)}</p>
            <small>${new Date(entry.created_at).toLocaleString()}</small>
            <button class="deleteBtn">Delete</button>
          `;
          journalList.appendChild(div);

          div.querySelector('.deleteBtn').addEventListener('click', async () => {
            if (confirm('Delete this entry?')) {
              try {
                const deleteRes = await fetch(`/api/journal/${entry.id}`, { method: 'DELETE' });
                if (deleteRes.ok) {
                  loadJournal();
                } else {
                  throw new Error('Failed to delete entry');
                }
              } catch (err) {
                console.error("Failed to delete entry:", err);
                alert('Failed to delete journal entry. Please try again.');
              }
            }
          });
        });
      } catch (err) {
        console.error("Failed to load journal:", err);
        if (journalList) {
          journalList.innerHTML = '<p class="error">Failed to load journal entries</p>';
        }
      }
    }

    if (journalList) loadJournal();
  </script>
</body>
</html>
